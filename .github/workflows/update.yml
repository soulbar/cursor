name: è‡ªåŠ¨æ›´æ–°è®¢é˜…é…ç½®

on:
  schedule:
    # æ¯3å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */3 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - '*.py'
      - 'config.py'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥åˆ›å»ºRelease
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: è¿è¡Œæ›´æ–°è„šæœ¬
        id: run_script
        run: |
          python main.py
      
      - name: è¯»å–é…ç½®ä¿¡æ¯
        id: config_info
        run: |
          python3 << EOF
          import os
          import yaml
          with open('clash-config.yaml', 'r', encoding='utf-8') as f:
              config = yaml.safe_load(f)
              node_count = len(config.get('proxies', []))
              output_file = os.environ.get('GITHUB_OUTPUT', '/dev/stdout')
              with open(output_file, 'a') as out:
                  out.write(f"node_count={node_count}\n")
          EOF
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check_changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add clash-config.yaml
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå°†æäº¤å¹¶åˆ›å»ºRelease"
          fi
      
      - name: æäº¤æ›´æ”¹
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "è‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶ [$(date '+%Y-%m-%d %H:%M:%S')]"
          git push
      
      - name: åˆ›å»ºRelease
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v$(date +%Y%m%d-%H%M%S)"
          name: "è‡ªåŠ¨æ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S')"
          body: |
            ## ğŸ“¦ è®¢é˜…é…ç½®æ›´æ–°
            
            - **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
            - **å¯ç”¨èŠ‚ç‚¹æ•°**: ${{ steps.config_info.outputs.node_count }}
            - **å»¶è¿Ÿé˜ˆå€¼**: 500ms
            
            ### ğŸ“¥ ä¸‹è½½é…ç½®
            
            ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½æŒ‰é’®ä¸‹è½½ `clash-config.yaml` æ–‡ä»¶ï¼Œç„¶åå¯¼å…¥åˆ°ä½ çš„Clashå®¢æˆ·ç«¯å³å¯ä½¿ç”¨ã€‚
            
            ### ğŸ”„ è‡ªåŠ¨æ›´æ–°
            
            æ­¤é…ç½®æ¯3å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œç¡®ä¿èŠ‚ç‚¹å§‹ç»ˆå¯ç”¨ã€‚
          files: clash-config.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

